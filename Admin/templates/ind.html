<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Library Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { background: #f8f9fa; }
    .card { border-radius: 12px; }
    canvas { background: white; padding: 10px; border-radius: 12px; }
  </style>
</head>
<body class="container py-4">

  <h1 class="mb-4 text-center">üìä Library Admin Dashboard</h1>

  <!-- Live Stats -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card p-3 text-center">
        <h5>Users Currently Inside</h5>
        <h2 id="insideCount">0</h2>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card p-3 text-center">
        <h5>Today's Entries</h5>
        <h2 id="todayEntries">0</h2>
      </div>
    </div>
  </div>

  <!-- Graphs -->
<div class="row mb-4">
  <div class="col-md-12">
    <div class="card p-3">
      <h5>Peak Hours (Today)</h5>
      <div class="chart-container">
        <canvas id="peakChart"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-4">
    <div class="card p-3">
      <h5>Daily Entries (Last 7 days)</h5>
      <div class="chart-container">
        <canvas id="dailyChart"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card p-3">
      <h5>Weekly Entries (Last Month)</h5>
      <div class="chart-container">
        <canvas id="weeklyChart"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card p-3">
      <h5>Monthly Entries (Last Year)</h5>
      <div class="chart-container">
        <canvas id="monthlyChart"></canvas>
      </div>
    </div>
  </div>
</div>

  <!-- Export Graphs -->
  <div class="mb-4">
    <button class="btn btn-danger" onclick="exportPDF()">Export Graphs as PDF</button>
  </div>

<!-- Active Users -->
<div class="card p-3 mb-4">
  <h5>Active Users (Inside)</h5>
  <div class="table-responsive scrollable-table">
    <table class="table table-striped" id="activeUsersTable">
      <thead class="table-dark">
        <tr>
          <th>Reg No</th><th>Name</th><th>Branch</th><th>Year</th><th>Role</th><th>Entry Time</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- User History Search -->
<div class="card p-3 mb-4">
  <h5>User History</h5>
  <div class="input-group mb-3">
    <input type="text" id="regNoInput" class="form-control" placeholder="Enter Registration No">
    <button class="btn btn-primary" onclick="fetchUserHistory()">Search</button>
  </div>
  <div class="table-responsive scrollable-table">
    <table class="table table-striped" id="historyTable">
      <thead class="table-dark">
        <tr>
          <th>Date</th><th>Entry Time</th><th>Exit Time</th><th>Name</th><th>Branch</th><th>Year</th><th>Role</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>


  <!-- Export Logs -->
  <div class="mb-4">
    <a href="/export/csv" class="btn btn-success">Export Logs (CSV)</a>
    <a href="/export/excel" class="btn btn-success">Export Logs (Excel)</a>
  </div>

  <script>
    const API_BASE = 'http://'+location.hostname+':5001';
    const charts = {}; // store chart instances

    // Load Live Stats
    async function loadLiveStats() {
      const res = await fetch(`${API_BASE}/api/live_stats`);
      const data = await res.json();
      document.getElementById('insideCount').innerText = data.inside;
      document.getElementById('todayEntries').innerText = data.today_entries;
    }

    // Load Active Users
    async function loadActiveUsers() {
      const res = await fetch(`${API_BASE}/api/active_users`);
      const data = await res.json();
      const tbody = document.querySelector('#activeUsersTable tbody');
      tbody.innerHTML = '';
      data.forEach(u => {
        tbody.innerHTML += `
          <tr>
            <td>${u.full_reg_no}</td>
            <td>${u.name}</td>
            <td>${u.branch}</td>
            <td>${u.year}</td>
            <td>${u.role}</td>
            <td>${u.entry_time}</td>
          </tr>
        `;
      });
    }

    // Chart Loader with fixed bar size
    async function loadChart(api, ctxId, label, fieldX, fieldY) {
  const res = await fetch(`${API_BASE}${api}`);
  const data = await res.json();

  const labels = data.map(d => d[fieldX]);
  const values = data.map(d => d[fieldY]);

  if (charts[ctxId]) {
    charts[ctxId].data.labels = labels;
    charts[ctxId].data.datasets[0].data = values;
    charts[ctxId].update();
  } else {
    const ctx = document.getElementById(ctxId).getContext("2d");
    charts[ctxId] = new Chart(ctx, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{
          label: label,
          data: values,
          backgroundColor: "#4f46e5",
          barThickness: 30  // fixed width bars
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,  // prevents stretching
        scales: {
          x: {
            ticks: { autoSkip: false, maxRotation: 45, minRotation: 0 }
          },
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }
}


// User History
async function fetchUserHistory() {
  const regNo = document.getElementById('regNoInput').value.trim();
  const tbody = document.querySelector('#historyTable tbody');
  tbody.innerHTML = '';

  if (!regNo) {
    alert("‚ö†Ô∏è Please enter a 5-digit Registration Number");
    return;
  }

  try {
    const res = await fetch(`/api/user_history/${regNo}`);
    
    if (!res.ok) {
      throw new Error("Server error: " + res.status);
    }

    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">‚ùå No history found for ${regNo}</td></tr>`;
      return;
    }

    data.forEach(h => {
      tbody.innerHTML += `
        <tr>
          <td>${h.entry_date || '-'}</td>
          <td>${h.entry_time || '-'}</td>
          <td>${h.exit_time || '-'}</td>
          <td>${h.name || '-'}</td>
          <td>${h.branch || '-'}</td>
          <td>${h.year || '-'}</td>
          <td>${h.role || '-'}</td>
          <td>-</td>
        </tr>
      `;
    });

  } catch (err) {
    console.error("Error fetching user history:", err);
    tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">‚ö†Ô∏è Error fetching data. Please try again later.</td></tr>`;
  }
}



    // Export Graphs as PDF
    async function exportPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p", "mm", "a4");
      let y = 10;

      for (const id of ["peakChart", "dailyChart", "weeklyChart", "monthlyChart"]) {
        const canvas = document.getElementById(id);
        const img = await html2canvas(canvas);
        const imgData = img.toDataURL("image/png");
        pdf.addImage(imgData, "PNG", 10, y, 180, 80);
        y += 90;
        if (y > 250) { pdf.addPage(); y = 10; }
      }

      pdf.save("graphs.pdf");
    }

// User History
async function fetchUserHistory() {
  const regNo = document.getElementById('regNoInput').value.trim();
  const tbody = document.querySelector('#historyTable tbody');
  tbody.innerHTML = '';

  // Validate 5-digit registration number
  if (!/^\d{5}$/.test(regNo)) {
    tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">‚ö†Ô∏è Please enter a valid 5-digit Registration Number</td></tr>`;
    return;
  }

  try {
    const res = await fetch('/api/user_history/' + regNo);

    if (!res.ok) {
      throw new Error("Server error: " + res.status);
    }

    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">‚ùå No history found for ${regNo}</td></tr>`;
      return;
    }

    // Populate table with results
    data.forEach(h => {
      tbody.innerHTML += `
        <tr>
          <td>${h.entry_date || '-'}</td>
          <td>${h.entry_time || '-'}</td>
          <td>${h.exit_time || '-'}</td>
          <td>${h.name || '-'}</td>
          <td>${h.branch || '-'}</td>
          <td>${h.year || '-'}</td>
          <td>${h.role || '-'}</td>
        </tr>
      `;
    });

  } catch (err) {
    console.error(err);
    tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">‚ö†Ô∏è Error fetching data. Please try again later.</td></tr>`;
  }
}


    // Init Dashboard
    loadLiveStats();
    loadActiveUsers();
    loadChart('/api/peak_hours_week', 'peakChart', 'Entries', 'hour', 'entries'); // weekly peak
    loadChart('/api/daily_entries', 'dailyChart', 'Entries', 'date', 'entries');
    loadChart('/api/weekly_entries', 'weeklyChart', 'Entries', 'week', 'entries');
    loadChart('/api/monthly_entries', 'monthlyChart', 'Entries', 'month', 'entries');

    // Refresh every 30s
    setInterval(() => {
      loadLiveStats();
      loadActiveUsers();
      loadChart('/api/peak_hours_week', 'peakChart', 'Entries', 'hour', 'entries');
      loadChart('/api/daily_entries', 'dailyChart', 'Entries', 'date', 'entries');
      loadChart('/api/weekly_entries', 'weeklyChart', 'Entries', 'week', 'entries');
      loadChart('/api/monthly_entries', 'monthlyChart', 'Entries', 'month', 'entries');
    }, 30000);
  </script>
</body>
</html>
